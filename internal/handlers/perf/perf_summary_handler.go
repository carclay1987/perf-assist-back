package perf

import (
	"net/http"

	"github.com/gin-gonic/gin"
)

// PerfGoal представляет структуру цели в перф-саммари
type PerfGoal struct {
	ID       string   `json:"id"`
	Title    string   `json:"title"`
	Context  string   `json:"context"`
	Outputs  []string `json:"outputs"`
	Outcomes []string `json:"outcomes"`
}

// PerfSummaryResponse представляет структуру ответа перф-саммари
type PerfSummaryResponse struct {
	ID          string     `json:"id"`
	PeriodStart string     `json:"period_start"`
	PeriodEnd   string     `json:"period_end"`
	SummaryText string     `json:"summary_text"`
	Goals       []PerfGoal `json:"goals"`
}

// PerfSummaryHandler отвечает за обработку запроса на получение перф-саммари
type PerfSummaryHandler struct{}

// NewPerfSummaryHandler создает новый экземпляр PerfSummaryHandler
func NewPerfSummaryHandler() *PerfSummaryHandler {
	return &PerfSummaryHandler{}
}

// Handle обрабатывает запрос на получение перф-саммари
func (h *PerfSummaryHandler) Handle(c *gin.Context) {
	if c.Request.Method != http.MethodPost {
		c.Status(http.StatusMethodNotAllowed)
		return
	}

	resp := PerfSummaryResponse{
		ID:          "mock-summary-1",
		PeriodStart: "2025-07-01",
		PeriodEnd:   "2025-12-31",
		SummaryText: "Черновик перф-саммари на основе нескольких развернутых примеров целей.",
		Goals:       mockGoals(),
	}

	c.JSON(http.StatusOK, resp)
}

// mockGoals возвращает mock данные для целей
func mockGoals() []PerfGoal {
	return []PerfGoal{
		{
			ID:      "goal-1",
			Title:   "Оптимизация производительности критических сервисов",
			Context: "В середине перф-цикла мы столкнулись с деградацией производительности нескольких ключевых API. Время отклика выросло до 800–1000 мс, участились таймауты, пользователи жаловались на медленную работу приложения. Параллельно рос трафик, и стало понятно, что текущая архитектура и настройки БД не выдерживают нагрузку. Я инициировал и возглавил работу по комплексной оптимизации производительности.",
			Outputs: []string{
				"Провёл профилирование 5 критических сервисов (tracing, pprof, анализ логов) и составил карту узких мест.",
				"Оптимизировал SQL-запросы: убрал N+1, добавил недостающие индексы, переписал несколько тяжёлых join-ов.",
				"Внедрил кэширование для часто запрашиваемых данных (Redis), добавил инвалидацию по ключевым событиям.",
				"Переписал часть бизнес-логики на более эффективные алгоритмы, убрал лишние синхронные вызовы.",
				"Настроил дашборды и алерты по latency, error rate и нагрузке на БД в Grafana/Prometheus.",
			},
			Outcomes: []string{
				"Снизил среднее время отклика API с ~850 мс до 140–180 мс (в 4–6 раз быстрее) под пиковой нагрузкой.",
				"Уменьшил нагрузку на основную БД на 60–70% за счёт оптимизаций и кэширования.",
				"Сократил долю запросов с таймаутами с 5% до <0.5%, что заметно улучшило UX.",
				"Команда получила набор best practices по профилированию и оптимизации, которые теперь используем в новых сервисах.",
			},
		},
		{
			ID:      "goal-2",
			Title:   "Миграция legacy-системы на современный стек",
			Context: "Наша команда поддерживала устаревшую систему на PHP 5.6 с монолитной архитектурой, которая стала серьезным бутылочным горлышком для развития продукта. Система часто падала, была трудна в поддержке и не масштабировалась. Я инициировал проект по миграции на современный микросервисный стек.",
			Outputs: []string{
				"Провёл аудит legacy-системы, выделил доменные области и определил границы будущих микросервисов.",
				"Спроектировал архитектуру нового решения на Go и gRPC, с использованием Kafka для асинхронной коммуникации.",
				"Разработал план поэтапной миграции с минимальным даунтаймом и возможностью отката.",
				"Реализовал первый микросервис с основной бизнес-логикой и настроил CI/CD пайплайны.",
				"Организовал процесс параллельного запуска старой и новой систем для постепенного переключения трафика.",
			},
			Outcomes: []string{
				"Успешно перенес 80% функциональности на новую архитектуру без даунтайма для пользователей.",
				"Сократил время обработки критических операций с 30 секунд до 200 мс.",
				"Повысил отказоустойчивость системы — теперь при падении одного сервиса не страдает вся система.",
				"Команда теперь может развивать отдельные части системы независимо, что ускорило вывод новых фич на 40%.",
			},
		},
		{
			ID:      "goal-3",
			Title:   "Повышение надежности и устойчивости системы к нагрузкам",
			Context: "После релиза нового функционала система начала падать под нагрузкой во время пиковых часов. Это приводило к недоступности сервиса для пользователей и финансовым потерям. Я возглавил проект по повышению надежности и устойчивости системы.",
			Outputs: []string{
				"Провёл стресс-тестирование системы с помощью k6 и выявил узкие места в обработке запросов.",
				"Внедрил circuit breaker паттерн для критических внешних зависимостей.",
				"Настроил graceful shutdown и health checks для всех сервисов.",
				"Реализовал retry логику с экспоненциальной задержкой для внешних вызовов.",
				"Добавил rate limiting на уровне API gateway и в самих сервисах.",
			},
			Outcomes: []string{
				"Снизил количество критических инцидентов с 5–7 в неделю до 0–1.",
				"Увеличил пропускную способность системы на 300% без масштабирования инфраструктуры.",
				"Время восстановления после сбоев сократилось с 30 минут до 2 минут благодаря автоматизации.",
				"Повысил уровень доверия бизнеса к технической стороне продукта.",
			},
		},
		{
			ID:      "goal-4",
			Title:   "Разработка и внедрение системы мониторинга и алертинга",
			Context: "Команда часто узнавала о проблемах в production только от пользователей, что приводило к длительному времени реакции и ухудшению пользовательского опыта. Требовалась система проактивного мониторинга и алертинга.",
			Outputs: []string{
				"Выбрал и внедрил стек мониторинга: Prometheus, Grafana, Loki, Tempo.",
				"Создал дашборды для визуализации ключевых метрик по доступности, latency, ошибкам и насыщению очередей.",
				"Настроил алерты с разными уровнями критичности и каналами уведомлений (Slack, PagerDuty).",
				"Реализовал сбор и анализ логов со всех сервисов с возможностью полнотекстового поиска.",
				"Создал runbook-и для стандартных инцидентов и провёл обучение команды.",
			},
			Outcomes: []string{
				"Сократил среднее время обнаружения инцидентов с 45 минут до 5 минут.",
				"Повысил прозрачность работы системы для всей команды и менеджмента.",
				"Уменьшил количество инцидентов, требующих участия on-call инженера, на 65%.",
				"Команда теперь может принимать архитектурные решения на основе данных, а не интуиции.",
			},
		},
		{
			ID:      "goal-5",
			Title:   "Оптимизация расходов на облачную инфраструктуру",
			Context: "Расходы на облачную инфраструктуру выросли на 300% за последний квартал, что стало критичным для бюджета компании. Требовалась оптимизация использования ресурсов без ущерба для производительности.",
			Outputs: []string{
				"Провёл аудит всех ресурсов в облаке и выявил неэффективные и неиспользуемые инстансы.",
				"Внедрил auto-scaling группы с настройкой горизонтального масштабирования по метрикам.",
				"Оптимизировал использование Kubernetes, настроил resource requests/limits для всех контейнеров.",
				"Перешёл с on-demand на spot инстансы для development и staging окружений.",
				"Настроил автоматическую остановку неиспользуемых ресурсов в нерабочее время.",
			},
			Outcomes: []string{
				"Сократил расходы на облачную инфраструктуру на 45% (~$120k в месяц).",
				"Повысил эффективность использования ресурсов: CPU utilization вырос с 15% до 65%.",
				"Автоматизировал процессы управления инфраструктурой, сэкономив 20 часов в месяц команды.",
				"Создал дашборд для отслеживания расходов с разбивкой по сервисам и командам.",
			},
		},
		{
			ID:      "goal-6",
			Title:   "Разработка и внедрение системы автоматического тестирования",
			Context: "Ручное тестирование перед каждым релизом занимало до 3 дней и часто пропускало баги в production. Требовалась система автоматического тестирования для повышения качества и скорости релизов.",
			Outputs: []string{
				"Разработал стратегию тестирования с пирамидой: unit, integration, e2e тесты.",
				"Внедрил CI pipeline с автоматическим запуском тестов при каждом коммите.",
				"Написал 80% code coverage для критических модулей системы.",
				"Настроил автоматическое тестирование UI с помощью Playwright для ключевых пользовательских сценариев.",
				"Интегрировал тесты с системой code review и релизным процессом.",
			},
			Outcomes: []string{
				"Сократил время релизного цикла с 1 недели до 1 дня.",
				"Снизил количество багов в production на 70%.",
				"Повысил уверенность команды в качестве кода и уменьшил страх перед изменениями.",
				"Автоматизировал 95% регрессионного тестирования, высвободив время для ручного тестирования UX.",
			},
		},
		{
			ID:      "goal-7",
			Title:   "Улучшение безопасности и соответствия требованиям",
			Context: "В ходе аудита безопасности были выявлены критические уязвимости в системе, включая отсутствие шифрования данных, слабую аутентификацию и недостаточный контроль доступа. Требовалась комплексная работа по повышению безопасности.",
			Outputs: []string{
				"Провёл threat modeling и выявил ключевые векторы атак.",
				"Внедрил end-to-end шифрование для всех данных в покое и в передаче.",
				"Реализовал двухфакторную аутентификацию и ролевую модель доступа (RBAC).",
				"Настроил автоматическое сканирование уязвимостей в CI/CD pipeline.",
				"Провёл обучение команды по безопасной разработке и создал security guidelines.",
			},
			Outcomes: []string{
				"Устранил все критические уязвимости, прошел повторный аудит безопасности.",
				"Получил сертификаты соответствия SOC 2 Type II и GDPR.",
				"Снизил количество инцидентов, связанных с безопасностью, на 95%.",
				"Повысил доверие клиентов и партнёров к нашей платформе.",
			},
		},
		{
			ID:      "goal-8",
			Title:   "Разработка и внедрение системы управления конфигурацией",
			Context: "Конфигурация сервисов была разбросана по разным репозиториям и окружениям, что приводило к ошибкам при деплое и сложностям в управлении изменениями. Требовалась централизованная система управления конфигурацией.",
			Outputs: []string{
				"Выбрал и внедрил HashiCorp Consul для хранения и управления конфигурациями.",
				"Разработал систему версионирования конфигураций с возможностью отката.",
				"Интегрировал систему конфигурации с CI/CD pipeline и процессом деплоя.",
				"Создал web UI для просмотра и редактирования конфигураций с аудитом изменений.",
				"Настроил автоматическое обновление конфигураций для сервисов без даунтайма.",
			},
			Outcomes: []string{
				"Сократил время на развертывание новых окружений с 2 дней до 2 часов.",
				"Устранил 90% ошибок, связанных с некорректной конфигурацией.",
				"Повысил прозрачность и контроль над изменениями конфигурации всей инфраструктуры.",
				"Команда теперь может безопасно экспериментировать с конфигурациями в изолированных окружениях.",
			},
		},
		{
			ID:      "goal-9",
			Title:   "Оптимизация процессов разработки и внедрение DevOps практик",
			Context: "Процесс разработки был хаотичным: долгие релизы, частые баги, отсутствие стандартов и плохая коммуникация между командами. Требовалась оптимизация процессов и внедрение DevOps практик.",
			Outputs: []string{
				"Внедрил Agile подход с двухнедельными спринтами и регулярными ретроспективами.",
				"Настроил CI/CD pipeline с автоматическим тестированием, сборкой и деплоем.",
				"Внедрил культуру code review и автоматических проверок качества кода.",
				"Создал систему документации с автоматической генерацией API specs.",
				"Организовал регулярные демо и планирование с заинтересованными сторонами.",
			},
			Outcomes: []string{
				"Сократил время вывода фич на рынок с 2 месяцев до 2 недель.",
				"Повысил качество кода: количество багов в production снизилось на 60%.",
				"Улучшил моральный климат в команде и прозрачность процессов для менеджмента.",
				"Команда стала более автономной и ответственной за результат.",
			},
		},
		{
			ID:      "goal-10",
			Title:   "Разработка и внедрение системы аналитики и бизнес-метрик",
			Context: "Продукт развивался без четкого понимания пользовательского поведения и бизнес-результатов. Команда принимала решения на основе предположений, а не данных. Требовалась система аналитики и метрик.",
			Outputs: []string{
				"Выбрал и внедрил стек аналитики: ClickHouse для хранения, Grafana для визуализации.",
				"Разработал систему сбора событий с фронтенда и бэкенда с помощью Kafka.",
				"Создал дашборды для отслеживания ключевых метрик: DAU, retention, конверсии, LTV.",
				"Реализовал A/B тестирование с корректной статистической моделью и визуализацией результатов.",
				"Настроил автоматические отчеты по ключевым метрикам для менеджмента.",
			},
			Outcomes: []string{
				"Повысил data-driven подход в компании: 90% продуктовых решений теперь основаны на данных.",
				"Увеличил retention на 25% за счет выявления и улучшения критических точек оттока.",
				"Сократил время на принятие продуктовых решений с 2 недель до 2 дней.",
				"Команда теперь может измерять эффективность фич и оптимизировать продукт на основе реальных данных.",
			},
		},
	}
}
